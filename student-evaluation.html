<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แบบประเมินการสอน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap');
    body { 
      font-family: 'Kanit', Tahoma, Arial, sans-serif; 
      background: #f7fafd; 
      margin: 0; 
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1em 0;
    }
    .container { 
      background: #fff; 
      padding: 2em; 
      border-radius: 18px; 
      max-width: 600px; 
      width: 95%;
      margin: 2em auto; 
      box-shadow: 0 8px 36px rgba(44, 62, 80, 0.11);
    }
    h2 { 
      text-align: center; 
      color: #2d87f0; 
      margin-top: 0; 
      margin-bottom: 1.5em;
    }
    .form-group { 
      margin-bottom: 1.5em;
    }
    label { 
      display: block; 
      margin-bottom: 0.5em; 
      color: #37474f; 
      font-weight: 500;
    }
    select, input[type="text"], textarea { 
      width: 100%; 
      box-sizing: border-box;
      padding: 0.7em; 
      border: 1.5px solid #b0bec5; 
      border-radius: 6px; 
      font-size: 1em; 
      font-family: inherit;
    }
    select:focus, input[type="text"]:focus, textarea:focus { 
      outline: none; 
      border-color: #2d87f0; 
      background: #e3f2fd;
    }
    .rating-group { 
      display: flex; 
      justify-content: space-around; 
      flex-wrap: wrap;
      margin: 1em 0;
      gap: 10px;
    }
    .rating-option { 
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .rating-option input { 
      margin-bottom: 0;
    }
    button[type="submit"] { 
      width: 100%; 
      padding: 0.8em; 
      background: linear-gradient(90deg,#2d87f0 60%,#5ad4fc 100%); 
      color: white; 
      border: none; 
      border-radius: 6px; 
      font-size: 1.1em; 
      cursor: pointer; 
      font-family: inherit; 
      font-weight: 600;
      transition: background-color 0.3s;
    }
    button[type="submit"]:disabled { 
      background: #b0bec5;
      cursor: not-allowed;
    }
    .error-msg { 
      color: #d32f2f; 
      background: #ffeaea; 
      border: 1px solid #ef9a9a; 
      padding: 1em; 
      border-radius: 7px; 
      margin-top: 1em; 
      display: none;
      text-align: center;
    }
    .success-msg { 
      text-align: center; 
      font-size: 1.2em; 
      color: #43a047; 
      margin-top: 2em; 
      font-weight: 600; 
      display: none;
    }
    @media (max-width: 480px) {
      .container { 
        margin: 1em; 
        padding: 1.5em;
      }
      .rating-group {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>แบบประเมินการสอน</h2>
    <form id="evaluationForm">
      <div class="form-group">
        <label for="center">ศูนย์</label>
        <select id="center" required>
          <option value="">เลือกศูนย์</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="week">สัปดาห์</label>
        <select id="week" required>
          <option value="">เลือกสัปดาห์</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="day">วัน</label>
        <select id="day" required>
          <option value="">เลือกวัน</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="period">ช่วงเวลา</label>
        <select id="period" required>
          <option value="">เลือกช่วงเวลา</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>ผู้สอน 1</label>
        <input type="text" id="instructor1" readonly style="background-color: #f0f0f0;">
      </div>
      
      <div class="form-group">
        <label>ผู้สอน 2</label>
        <input type="text" id="instructor2" readonly style="background-color: #f0f0f0;">
      </div>

      <!-- Rating Sections -->
      <div class="form-group">
        <label>1. ความชัดเจนในการสอน</label>
        <div class="rating-group" id="clarity_rating"></div>
      </div>

      <div class="form-group">
        <label>2. การเตรียมการสอน</label>
        <div class="rating-group" id="preparation_rating"></div>
      </div>

      <div class="form-group">
        <label>3. การมีปฏิสัมพันธ์กับผู้เรียน</label>
        <div class="rating-group" id="interaction_rating"></div>
      </div>

      <div class="form-group">
        <label>4. การตรงต่อเวลา</label>
        <div class="rating-group" id="punctuality_rating"></div>
      </div>
      
      <div class="form-group">
        <label>5. ความพึงพอใจโดยรวม</label>
        <div class="rating-group" id="satisfaction_rating"></div>
      </div>

      <div class="form-group">
        <label for="comment">ข้อเสนอแนะเพิ่มเติม</label>
        <textarea id="comment" rows="4"></textarea>
      </div>

      <button type="submit">ส่งแบบประเมิน</button>
    </form>
    
    <div class="error-msg" id="errorMsg"></div>
    <div class="success-msg" id="successMsg">ส่งแบบประเมินเรียบร้อยแล้ว ขอบคุณสำหรับการประเมิน!</div>
  </div>

<script>
// --- CONFIGURATION ---
// !!! สำคัญ: กรุณาเปลี่ยน URL นี้เป็น URL ของ Google Apps Script Web App ของคุณ
const API_URL = 'https://script.google.com/macros/s/AKfycbxI1-QQAoSNJa-o_sM3v8ak6x4KxTRybpMjDcX0vrWH6fiUrU-LiuM9KoNm3J8bIMSC/exec';

// --- DATA ---
const centers = ['ลาดกระบัง', 'บางพลัด', 'ระยอง', 'ศรีราชา'];
const weeks = [1, 2, 3, 4, 5, 6, 7, 8];
const days = ['เสาร์', 'อาทิตย์'];
const periods = ['เช้า', 'บ่าย'];
const ratingCategories = [
    { id: 'clarity', label: 'ความชัดเจนในการสอน' },
    { id: 'preparation', label: 'การเตรียมการสอน' },
    { id: 'interaction', label: 'การมีปฏิสัมพันธ์กับผู้เรียน' },
    { id: 'punctuality', label: 'การตรงต่อเวลา' },
    { id: 'satisfaction', label: 'ความพึงพอใจโดยรวม' }
];
const ratingLabels = ['น้อยที่สุด', 'น้อย', 'ปานกลาง', 'มาก', 'มากที่สุด'];

let instructorsMap = {};

// --- FUNCTIONS ---
function populateSelect(elementId, options, placeholder) {
    const select = document.getElementById(elementId);
    select.innerHTML = `<option value="">${placeholder}</option>` + 
        options.map(o => `<option value="${o}">${o}</option>`).join('');
}

function createRatingOptions(categoryId) {
    const container = document.getElementById(`${categoryId}_rating`);
    container.innerHTML = ratingLabels.map((label, index) => `
        <div class="rating-option">
            <input type="radio" name="${categoryId}" id="${categoryId}_${index+1}" value="${index+1}" required>
            <label for="${categoryId}_${index+1}">${label}</label>
        </div>
    `).join('');
}

function updateInstructors() {
  const center = document.getElementById('center').value;
  const week = document.getElementById('week').value;
  const day = document.getElementById('day').value;
  const period = document.getElementById('period').value;
  
  const instructor1Input = document.getElementById('instructor1');
  const instructor2Input = document.getElementById('instructor2');
  
  instructor1Input.value = '';
  instructor2Input.value = '';
  
  if (center && week && day && period) {
    if (instructorsMap[center]?.[week]?.[day]?.[period]) {
      const data = instructorsMap[center][week][day][period];
      instructor1Input.value = data.instructor1 || '';
      instructor2Input.value = data.instructor2 || '';
    }
  }
}

function fetchInstructors() {
  fetch(`${API_URL}?action=getInstructors`)
    .then(r => r.json())
    .then(data => {
      if (data.status === 'success') {
        instructorsMap = data.data || {};
        updateInstructors();
      } else {
        throw new Error(data.message || 'โหลดข้อมูลผู้สอนไม่สำเร็จ');
      }
    })
    .catch(error => {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
      errorMsg.style.display = 'block';
    });
}

// --- EVENT LISTENERS AND INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Populate dropdowns
    populateSelect('center', centers, 'เลือกศูนย์');
    populateSelect('week', weeks, 'เลือกสัปดาห์');
    populateSelect('day', days, 'เลือกวัน');
    populateSelect('period', periods, 'เลือกช่วงเวลา');

    // Create rating options
    ratingCategories.forEach(cat => createRatingOptions(cat.id));

    // Add event listeners to dropdowns
    ['center', 'week', 'day', 'period'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateInstructors);
    });

    // Fetch initial instructor data
    fetchInstructors();

    // Handle form submission
    document.getElementById('evaluationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        errorMsg.style.display = 'none';

        const payload = {
            action: 'submitEvaluation',
            center: document.getElementById('center').value,
            week: document.getElementById('week').value,
            day: document.getElementById('day').value,
            period: document.getElementById('period').value,
            instructor1: document.getElementById('instructor1').value,
            instructor2: document.getElementById('instructor2').value,
            comment: document.getElementById('comment').value,
        };
        
        // Add ratings to payload
        let allRatingsProvided = true;
        ratingCategories.forEach(cat => {
            const checkedRadio = document.querySelector(`input[name="${cat.id}"]:checked`);
            if (checkedRadio) {
                payload[cat.id] = checkedRadio.value;
            } else {
                allRatingsProvided = false;
            }
        });

        if (!payload.instructor1 && !payload.instructor2) {
            errorMsg.textContent = 'กรุณาเลือกศูนย์/สัปดาห์/วัน/เวลา ที่มีตารางสอน';
            errorMsg.style.display = 'block';
            return;
        }

        if (!allRatingsProvided) {
            errorMsg.textContent = 'กรุณาให้คะแนนให้ครบทุกหัวข้อ';
            errorMsg.style.display = 'block';
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'กำลังส่งข้อมูล...';

        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('evaluationForm').style.display = 'none';
                successMsg.style.display = 'block';
            } else {
                throw new Error(data.message || 'ส่งข้อมูลไม่สำเร็จ');
            }
        })
        .catch(error => {
            errorMsg.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            errorMsg.style.display = 'block';
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ส่งแบบประเมิน';
        });
    });
});
</script>
</body>
</html>
